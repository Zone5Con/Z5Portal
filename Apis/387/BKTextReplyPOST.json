{
  "Name": "BKTextReply",
  "Description": "Wholesale Text Reply",
  "HttpMethod": "POST",
  "IsEnabled": true,
  "OrderIndex": 0,
  "CrossDomainPolicy": "Public",
  "Inputs": [
    {
      "Name": "MessageStatus",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 0,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    }
  ],
  "Actions": [
    {
      "ActionType": "TwilioParseWebhook",
      "OrderIndex": 0,
      "Parameters": {
        "OutputToken": "BKReturn"
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Cell from SMS Message",
      "ActionType": "RunSql",
      "OrderIndex": 1,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select RIGHT('[BKReturn:From]',10)",
        "BindTokens": "",
        "OutputTokenName": "CellRaw",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Format Cell with - - -",
      "ActionType": "RunSql",
      "OrderIndex": 2,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Format([CellRaw], '###-###-####')",
        "BindTokens": "",
        "OutputTokenName": "CellFormatted",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Stop",
      "ActionType": "RunSql",
      "OrderIndex": 3,
      "Condition": "[BKReturn:Body].ToLower == 'stop' || [BKReturn:Body].ToLower == 'stop ' || [BKReturn:Body].ToLower == ' stop' || [BKReturn:Body].ToLower == ' stop ' || || [BKReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Update app.TextOptIn \nSet OptIn = 'stop', DateOptIn = NULL, DateStop = '[Date:EasternDateTime]'\nwhere CellPhone = RIGHT('[BKReturn:From]',10)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Data for Stop",
      "ActionType": "RunSql",
      "OrderIndex": 4,
      "Condition": "[BKReturn:Body].ToLower == 'stop' || [BKReturn:Body].ToLower == 'stop ' || [BKReturn:Body].ToLower == ' stop' || [BKReturn:Body].ToLower == ' stop ' || || [BKReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Top 1 FileId from app.AVMTextMessage\nWhere  CellPhone = '[CellFormatted]'\nOrder By TimeStamp DESC",
        "BindTokens": "",
        "OutputTokenName": "BKText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Start",
      "ActionType": "RunSql",
      "OrderIndex": 6,
      "Condition": "[BKReturn:Body].ToLower == 'start' || [BKReturn:Body].ToLower == 'start ' || [BKReturn:Body].ToLower == ' start' || [BKReturn:Body].ToLower == ' start ' || || [BKReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Update app.TextOptIn \nSet OptIn = 'yes', DateOptIn = '[Date:EasternDateTime]', DateStop = NULL\nwhere CellPhone = RIGHT('[BKReturn:From]',10)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Data for Start",
      "ActionType": "RunSql",
      "OrderIndex": 7,
      "Condition": "[BKReturn:Body].ToLower == 'start' || [BKReturn:Body].ToLower == 'start ' || [BKReturn:Body].ToLower == ' start' || [BKReturn:Body].ToLower == ' start ' || || [BKReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Top 1 FileId from app.AVMTextMessage\nWhere  CellPhone = '[CellFormatted]'\nOrder By TimeStamp DESC",
        "BindTokens": "",
        "OutputTokenName": "BKText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Insert 1 Bor or COB",
      "ActionType": "RunSql",
      "OrderIndex": 9,
      "Condition": "false",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into MepTextMessages (Response, Status, StatusHTML, SentTo, LoanGuid, LoanNumber, SentBy, SentByEmail, TextMessage, TextMessageHTML, DateSent, NewFlag) Values (\n'[Mep2:MessageSid]',\n'received',\n'<p><strong><span style=\"color: #0c84e4;\">Received</span></strong></p>',\n'[LoanData:SentBy]',\n'[LoanData:LoanGuid]',\n'[LoanData:LoanNumber]',\n'[LoanData:SentTo]',\n'[LoanData:SentByEmail]',\nN'[Mep2:Body]',\nN'<div class=\"message-blue\"> <p class=\"message-content\">[Mep2:Body]</p><div class=\"message-timestamp-right\">[LoanData:SentTo]</div></div>',\n'[Date:EasternDateTime]',\n'yes'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    }
  ],
  "OnErrorActions": []
}