{
  "Name": "AVMSendText",
  "HttpMethod": "POST",
  "IsEnabled": true,
  "OrderIndex": 0,
  "CrossDomainPolicy": "Public",
  "Inputs": [],
  "Actions": [
    {
      "ActionType": "ParseJsonIntoTokens",
      "OrderIndex": 0,
      "Parameters": {
        "JsonString": "[RawInput]",
        "BaseTokenName": "AVM"
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "check phone number",
      "ActionType": "RunSql",
      "OrderIndex": 1,
      "Condition": "[AVM:CellPhone] != \"\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "SELECT CASE\n                 WHEN [AVM:CellPhone] LIKE CONCAT('[23456789]', REPLICATE('[0123456789]', 9))\n                      AND [AVM:CellPhone] LIKE CONCAT('%[^', LEFT([AVM:CellPhone], 1), ']%')\n                   THEN 'yes'\n                 ELSE 'no' \n               END",
        "BindTokens": "",
        "OutputTokenName": "Valid",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "CellPhone must be valid",
      "ActionType": "RawResponse",
      "OrderIndex": 2,
      "Condition": "[Valid] == \"no\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The CellPhone parameter is not a valid phone number\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "File Id Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 3,
      "Condition": "[AVM:FileId] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The FileId parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Loan Number Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 4,
      "Condition": "[AVM:LoanNumber] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The LoanNumber parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "SentFrom Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 5,
      "Condition": "[AVM:SentFrom] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The SentFrom parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "SentTo Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 6,
      "Condition": "[AVM:SentTo] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The SentTo parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "CellPhone Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 7,
      "Condition": "[AVM:CellPhone] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The CellPhone parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Message Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 8,
      "Condition": "[AVM:Message] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The Message parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "BorName Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 9,
      "Condition": "[AVM:BorName] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The BorName parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "PropAddress Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 10,
      "Condition": "[AVM:PropAddress] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The PropAddress parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "ValueTrac ID Cannot be blank",
      "ActionType": "RawResponse",
      "OrderIndex": 11,
      "Condition": "[AVM:VtMessageId] == \"\"",
      "Parameters": {
        "Content": "{\n    \"error\": \"The VtMessageId parameter cannot be blank\"\n}",
        "HttpCode": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "ContentType"
          }
        ]
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Add Text Message - First Time for Appraiser",
      "ActionType": "RunSql",
      "OrderIndex": 12,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "IF NOT EXISTS (SELECT TokenId FROM app.AVMAppraiser \nWHERE FileId = '[AVM:FileId]' and AppraiserCellPhone = '[AVM:CellPhone]' )\nBEGIN\nINSERT INTO app.AVMAppraiser (AppraiserCellPhone, AppraiserName, FileId, TokenId)\nValues (\n'[AVM:CellPhone]',\n'[AVM:SentTo]',\n'[AVM:FileId]',\n'[AVM:AppToken]'\n)\n\nEND",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Delay 1 sec",
      "ActionType": "RunSql",
      "OrderIndex": 13,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "WAITFOR DELAY '00:00:01'",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Token Id",
      "ActionType": "RunSql",
      "OrderIndex": 14,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "select TokenId from app.AVMAppraiser\nWhere FileId = '[AVM:FileId]' and AppraiserCellPhone = '[AVM:CellPhone]'",
        "BindTokens": "",
        "OutputTokenName": "AVT",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "ActionType": "TwilioSendSms",
      "OrderIndex": 15,
      "Condition": "[Valid] == \"yes\"",
      "Parameters": {
        "Credentials": {
          "Type": "twilio.apikeys",
          "Group": "2",
          "EntireGroup": false,
          "Entry": "d5763e2b-6094-464e-a101-e890763b7a6a"
        },
        "FromNumber": "+16174683541",
        "ToNumber": "+1[AVM:CellPhone]",
        "SmsBody": "Ref: [AVM:PropAddress] - [AVM:Message] - Reply Here: http://rply.cc?tkn=[AVT:TokenId] - STOP to cancel",
        "StatusCallbackUrl": "https://z5portal.com/DesktopModules/DnnSharp/DnnApiEndpoint/Api.ashx?method=AVMMessageStatus",
        "OutputMessageId": "MessageId",
        "IgnoreErrors": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Add Appraiser to AVM Appraiser",
      "ActionType": "RunSql",
      "OrderIndex": 16,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "INSERT INTO app.AVMTextMessage (FileId, VtMessageId, MessageId, LoanNumber, TimeStamp, SentFrom, SentTo, CellPhone, Message, MessageHTML, BorName, PropAddress, TokenId )\nValues (\n'[AVM:FileId]',\n'[AVM:VtMessageId]',\n'[MessageId]',\n'[AVM:LoanNumber]',\n'[AVM:TimeStamp]',\n'[AVM:SentFrom]',\n'[AVM:SentTo]',\n'[AVM:CellPhone]',\n'[AVM:Message] - STOP to cancel',\n'<div class=\"bubbleEnc\"><div class=\"txt\"><p class=\"nameEncLeftBor\">Sent To: [AVM:SentTo]</p><p class=\"messageEnc\">[AVM:Message] - STOP to cancel</p><span class=\"timestampEnc\">From [AVM:SentFrom] [Time:EasternShort]</span></div><div class=\"bubble-arrowEnc\"></div></div></div>',\n'[AVM:BorName]',\n'[AVM:PropAddress]',\n'[AVT:TokenId]'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "ActionType": "SendMail",
      "OrderIndex": 17,
      "Condition": "0",
      "Parameters": {
        "From": "",
        "To": "craig@verticaldemand.com",
        "DetermineEmail": "",
        "ToAllUsers": "",
        "ReplyTo": "",
        "Cc": "",
        "Bcc": "",
        "Subject": "Valid",
        "Format": {
          "Expression": "",
          "Value": "Html",
          "IsExpression": false,
          "Parameters": {}
        },
        "DnnEmailTemplate": {
          "Expression": "",
          "Value": "",
          "IsExpression": false,
          "Parameters": {}
        },
        "Body": "<p><span style=\"background-color: transparent; font-family: inherit;\">[Valid]</span><br></p>",
        "Headers": "",
        "PortalFiles": "",
        "FileToken1": "",
        "IgnoreErros": ""
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    }
  ],
  "OnErrorActions": []
}