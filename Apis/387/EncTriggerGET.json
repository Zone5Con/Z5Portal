{
  "Name": "EncTrigger",
  "Description": "Encompass Trigger",
  "HttpMethod": "GET",
  "IsEnabled": true,
  "OrderIndex": 0,
  "CrossDomainPolicy": "Public",
  "Inputs": [
    {
      "Name": "LG",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 0,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "LN",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 1,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "BCP",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 2,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "number",
      "Validations": []
    },
    {
      "Name": "BST",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 3,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "SB",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 4,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "TM",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 5,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "CCP",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 6,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "number",
      "Validations": []
    },
    {
      "Name": "CST",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 7,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "CMS",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 8,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    },
    {
      "Name": "CID",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 9,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    }
  ],
  "Actions": [
    {
      "ActionType": "SendMail",
      "OrderIndex": 0,
      "Condition": "false",
      "Parameters": {
        "From": "",
        "To": "craig@verticaldemand.com",
        "DetermineEmail": "",
        "ToAllUsers": "",
        "ReplyTo": "",
        "Cc": "",
        "Bcc": "",
        "Subject": "API Test",
        "Format": {
          "Expression": "",
          "Value": "Html",
          "IsExpression": false,
          "Parameters": {}
        },
        "DnnEmailTemplate": {
          "Expression": "",
          "Value": "",
          "IsExpression": false,
          "Parameters": {}
        },
        "Body": "<p>[LG]</p><p>[LN]</p><p>[CID]</p><p>[BCP]</p><p>[BST]</p><p>[CCP]</p><p>[CST]</p><p>[TM]</p><p>[CMS]</p><p>[SB]</p>",
        "Headers": "",
        "PortalFiles": "",
        "FileToken1": "",
        "IgnoreErros": ""
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Check Opt In Borrower",
      "ActionType": "RunSql",
      "OrderIndex": 1,
      "Condition": "[BCP] != \"\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "select OptIn from app.TextOptIn where\nCellPhone = '[BCP]'",
        "BindTokens": "",
        "OutputTokenName": "BorOptIn",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Check Opt In Co-Borrower",
      "ActionType": "RunSql",
      "OrderIndex": 2,
      "Condition": "[CCP] != \"\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "select OptIn from app.TextOptIn where\nCellPhone = '[CCP]'",
        "BindTokens": "",
        "OutputTokenName": "CobOptIn",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Check if Okay to send TimeZone",
      "ActionType": "RunSql",
      "OrderIndex": 3,
      "Condition": "[BorOptIn] == \"yes\" || [CobOptIn] == \"yes\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "select Case\n  When '[Time:Eastern]' > '08:05:00' and '[Time:Eastern]' < '20:55:00' Then 'yes'\n  Else 'no'\n  End",
        "BindTokens": "",
        "OutputTokenName": "SendText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Wording",
      "ActionType": "RunSql",
      "OrderIndex": 4,
      "Condition": "[SendText] == \"yes\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "select TextMessage from app.TextMessageAuto where\nCompanyId = '[CID]' and Number = '[TM]'",
        "BindTokens": "",
        "OutputTokenName": "Message",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Insert for Borrower to Queue",
      "ActionType": "RunSql",
      "OrderIndex": 5,
      "Condition": "[BorOptIn] == \"yes\" && [SendText] == \"no\" && [BCP] != \"\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into app.TextQueue (CompanyId, LoanNumber, CellPhone, SentTo, TextMessage, Party, SentBy, LoanGuid, CompletedMS ) Values (\n'[CID]',\n'[LN]',\n'[BCP]',\n'[BST]',\n'[Message]',\n'Enc',\n'[SB]',\nREPLACE(REPLACE('[LG]', '{', ''), '}', ''),\n'[CMS]'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Insert for Co-Borrower to Queue",
      "ActionType": "RunSql",
      "OrderIndex": 6,
      "Condition": "[CobOptIn] == \"yes\" && [SendText] == \"no\" && [CCP] != \"\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into app.TextQueue (CompanyId, LoanNumber, CellPhone, SentTo, TextMessage, Party, SentBy, LoanGuid, CompletedMS ) Values (\n'[CID]',\n'[LN]',\n'[CCP]',\n'[CST]',\n'[Message]',\n'Enc',\n'[SB]',\nREPLACE(REPLACE('[LG]', '{', ''), '}', ''),\n'[CMS]'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Borrower",
      "ActionType": "TwilioSendSms",
      "OrderIndex": 7,
      "Condition": "[BorOptIn] == \"yes\" && [BCP] != \"\" && [SendText] == \"yes\"",
      "Parameters": {
        "Credentials": {
          "Type": "twilio.apikeys",
          "Group": "2",
          "EntireGroup": false,
          "Entry": "d5763e2b-6094-464e-a101-e890763b7a6a"
        },
        "FromNumber": "+1[LOSM:SMSFrom]",
        "ToNumber": "+1[BCP]",
        "SmsBody": "Loan Update - [Message] [LOSM:FooterMessage]",
        "StatusCallbackUrl": "[LOSM:CallBackURL]",
        "OutputMessageId": "[MessageIdEncBor]",
        "OnError": [],
        "-1": [],
        "IgnoreErrors": ""
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Length - total characters",
      "ActionType": "RunSql",
      "OrderIndex": 8,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "SELECT LEN('[Message] [LOSM:FooterMessage]')",
        "BindTokens": "",
        "OutputTokenName": "TotalLength",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Total Count of Messages",
      "ActionType": "RunSql",
      "OrderIndex": 9,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select \nCASE\nWhen [TotalLength] >= 320 Then 3\nWhen [TotalLength] > 160 Then 2\nWhen [TotalLength] <= 160 Then 1\nEND AS TotalCount",
        "BindTokens": "",
        "OutputTokenName": "TotalCount",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Insert for Borrower",
      "ActionType": "RunSql",
      "OrderIndex": 10,
      "Condition": "[BorOptIn] == \"yes\" && [BCP] != \"\" && [SendText] == \"yes\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into app.TextMessage (CompanyId, MessageId, DeliveryStatus, DeliveryStatusHTML, LoanNumber, CellPhone, SentTo, TextMessage, TextMessageHTML, Party, SentBy, LoanGuid, DateSent, \nCompletedMS, TotalCount, TotalCharacters ) Values (\n'[CID]',\n'[MessageIdEncBor]',\n'delivered',\n'<p><strong><span style=\"color: #339966;\">delivered</span></strong></p>',\n'[LN]',\n'[BCP]',\n'[BST]',\n'[Message] [LOSM:FooterMessage]',\n'<div class=\"bubbleEnc\"><div class=\"txt\"><p class=\"nameEncLeftBor\">Sent To: [BST]</p><p class=\"messageEnc\">[Message] [LOSM:FooterMessage]</p><span class=\"timestampEnc\">Sent By: Encompass on [Time:EasternShort]</span></div><div class=\"bubble-arrowEnc\"></div></div></div>',\n'Enc',\n'[SB]',\nREPLACE(REPLACE('[LG]', '{', ''), '}', ''),\n'[Date:EasternDateTime]',\n'[CMS]',\n'[TotalCount]',\n'[TotalLength]'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false,
        "-1": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Co-Borrower",
      "ActionType": "TwilioSendSms",
      "OrderIndex": 11,
      "Condition": "[CobOptIn] == \"yes\" && [CCP] != \"\" && [SendText] == \"yes\"",
      "Parameters": {
        "Credentials": {
          "Type": "twilio.apikeys",
          "Group": "2",
          "EntireGroup": false,
          "Entry": "d5763e2b-6094-464e-a101-e890763b7a6a"
        },
        "FromNumber": "+1[LOSM:SMSFrom]",
        "ToNumber": "+1[CCP]",
        "SmsBody": "Loan Update - [Message] [LOSM:FooterMessage]",
        "StatusCallbackUrl": "[LOSM:CallBackURL]",
        "OutputMessageId": "[MessageIdEncCob]",
        "OnError": [],
        "-1": [],
        "IgnoreErrors": ""
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Insert for Co-Borrower",
      "ActionType": "RunSql",
      "OrderIndex": 12,
      "Condition": "[CobOptIn] == \"yes\" && [CCP] != \"\" && [SendText] == \"yes\"",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into app.TextMessage (CompanyId, MessageId, DeliveryStatus, DeliveryStatusHTML, LoanNumber, CellPhone, SentTo, TextMessage, TextMessageHTML, Party, SentBy, LoanGuid, DateSent, CompletedMS, TotalCount, TotalCharacters ) Values (\n'[CID]',\n'[MessageIdEncCob]',\n'delivered',\n'<p><strong><span style=\"color: #339966;\">delivered</span></strong></p>',\n'[LN]',\n'[CCP]',\n'[BST]',\n'[Message] [LOSM:FooterMessage]',\n'<div class=\"bubbleEnc\"><div class=\"txt\"><p class=\"nameEncLeftBor\">Sent To: [CST]</p><p class=\"messageEnc\">[Message] [LOSM:FooterMessage]</p><span class=\"timestampEnc\">Sent By: Encompass on [Time:EasternShort]</span></div><div class=\"bubble-arrowEnc\"></div></div></div>',\n'Enc',\n'[SB]',\nREPLACE(REPLACE('[LG]', '{', ''), '}', ''),\n'[Date:EasternDateTime]',\n'[CMS]',\n'[TotalCount]',\n'[TotalLength]'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false,
        "-1": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    }
  ],
  "OnErrorActions": []
}