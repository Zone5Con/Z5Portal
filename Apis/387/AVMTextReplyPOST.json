{
  "Name": "AVMTextReply",
  "Description": "Absolute Value Appraisal Mangement Text Reply",
  "HttpMethod": "POST",
  "IsEnabled": true,
  "OrderIndex": 0,
  "CrossDomainPolicy": "Public",
  "Inputs": [
    {
      "Name": "MessageStatus",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 0,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    }
  ],
  "Actions": [
    {
      "ActionType": "TwilioParseWebhook",
      "OrderIndex": 0,
      "Parameters": {
        "OutputToken": "AVMReturn"
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Cell from SMS Message",
      "ActionType": "RunSql",
      "OrderIndex": 1,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select RIGHT('[AVMReturn:From]',10)",
        "BindTokens": "",
        "OutputTokenName": "CellRaw",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Data",
      "ActionType": "RunSql",
      "OrderIndex": 2,
      "Condition": "",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Top 1 * from app.AVMTextMessage\nWhere  CellPhone = '[CellRaw]'\nOrder By TimeStamp DESC",
        "BindTokens": "",
        "OutputTokenName": "AVMText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Delay 3 sec",
      "ActionType": "RunSql",
      "OrderIndex": 3,
      "Condition": "",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "WAITFOR DELAY '00:00:03';",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "STOP - Update AVPAppraiser with Opt Out",
      "ActionType": "RunSql",
      "OrderIndex": 4,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Update app.AVMAppraiser \nSet OptOutText = 'yes', OptOutDate = '[Date:EasternDateTime]'\nwhere AppraiserCellPhone = '[CellRaw]'",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "STOP - Insert New Row - AVMTextMessage",
      "ActionType": "RunSql",
      "OrderIndex": 5,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into app.AVMTextMessage (FileId, VTMessageId, LoanNumber, TimeStamp, SentFrom, SentTo, Message, MessageHTML, BorName, PropAddress, TokenId)\nValues\n(\n'[AVMText:FileId]',\n'[AVMText:VtMessageId]',\n'[AVMText:LoanNumber]',\n'[Date:AVMEastern]',\n'[AVMText:SentTo]',\n'Absolute Value',\n'STOP',\n'<div class=\"bubbleBor\"><div class=\"txt\"><p class=\"name\">From: [AVMText:SentTo]</p><p class=\"messageBor\">STOP</p><span class=\"timestampBor\">[Time:EasternShort]</span></div><div class=\"bubble-arrow\"></div></div>',\n'[AVMText:BorName]',\n'[AVMText:PropAddress]',\n'[AVMText:TokenId]'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "STOP - Post back to ValueTrac with STOP",
      "ActionType": "PostData",
      "OrderIndex": 6,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "InputParameters": "",
        "URL": "https://avm-staging.myvalutrac.com/api/sms.aspx?key=IGNYfZXhSD3rZarPu4Jz",
        "UrlTokenContext": {
          "Expression": "",
          "Value": "Url",
          "IsExpression": false,
          "Parameters": {}
        },
        "UseSSL": true,
        "Timeout": "",
        "HttpMethod": {
          "Expression": "",
          "Value": "POST",
          "IsExpression": false,
          "Parameters": {}
        },
        "Data": "{\n      \"VtMessageId\": \"[AVMText:VtMessageId]\",\n      \"TimeStamp\": \"[Date:AVMEastern]\",\n      \"VerticalDemandId\": \"[AVMText:MessageSid]\",\n      \"Status\": \"Stop\",\n      \"Descr\": \"Appraiser has Opted Out\"\n}",
        "DoNotEscapeTokens": "",
        "DisableReferer": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "Content-Type"
          }
        ],
        "UseDNNProxySettings": "",
        "AddCurrentCookies": "",
        "OutputParameters": "",
        "CookieContainerToken": "",
        "OutputTokenName": "",
        "OutputHeaders": "",
        "IgnoreErrors": "",
        "Events": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "START - Update AVPAppraiser with Opt Back In",
      "ActionType": "RunSql",
      "OrderIndex": 7,
      "Condition": "[AVMReturn:Body].ToLower == 'start' || [AVMReturn:Body].ToLower == 'start ' || [AVMReturn:Body].ToLower == ' start' || [AVMReturn:Body].ToLower == ' start ' || [AVMReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Update app.AVMAppraiser \nSet OptOutText = NULL, OptOutDate = NULL\nwhere AppraiserCellPhone = '[CellRaw]'",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "START - Insert New Row - AVMTextMessage",
      "ActionType": "RunSql",
      "OrderIndex": 8,
      "Condition": "[AVMReturn:Body].ToLower == 'start' || [AVMReturn:Body].ToLower == 'start ' || [AVMReturn:Body].ToLower == ' start' || [AVMReturn:Body].ToLower == ' start ' || [AVMReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into app.AVMTextMessage (FileId, VTMessageId, LoanNumber, TimeStamp, SentFrom, SentTo, Message, MessageHTML, BorName, PropAddress, TokenId)\nValues\n(\n'[AVMText:FileId]',\n'[AVMText:VtMessageId]',\n'[AVMText:LoanNumber]',\n'[Date:AVMEastern]',\n'[AVMText:SentTo]',\n'Absolute Value',\n'START',\n'<div class=\"bubbleBor\"><div class=\"txt\"><p class=\"name\">From: [AVMText:SentTo]</p><p class=\"messageBor\">STOP</p><span class=\"timestampBor\">[Time:EasternShort]</span></div><div class=\"bubble-arrow\"></div></div>',\n'[AVMText:BorName]',\n'[AVMText:PropAddress]',\n'[AVMText:TokenId]'\n)",
        "BindTokens": "",
        "OutputTokenName": "AVMText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "START - Post back to ValueTrac with START",
      "ActionType": "PostData",
      "OrderIndex": 9,
      "Condition": "[AVMReturn:Body].ToLower == 'start' || [AVMReturn:Body].ToLower == 'start ' || [AVMReturn:Body].ToLower == ' start' || [AVMReturn:Body].ToLower == ' start ' || [AVMReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "InputParameters": "",
        "URL": "https://avm-staging.myvalutrac.com/api/sms.aspx?key=IGNYfZXhSD3rZarPu4Jz",
        "UrlTokenContext": {
          "Expression": "",
          "Value": "Url",
          "IsExpression": false,
          "Parameters": {}
        },
        "UseSSL": true,
        "Timeout": "",
        "HttpMethod": {
          "Expression": "",
          "Value": "POST",
          "IsExpression": false,
          "Parameters": {}
        },
        "Data": "{\n      \"VtMessageId\": \"[AVMText:VtMessageId]\",\n      \"TimeStamp\": \"[Date:AVMEastern]\",\n      \"VerticalDemandId\": \"[AVMText:MessageSid]\",\n      \"Status\": \"START\",\n      \"Descr\": \"Appraiser has Opted Back In\"\n}",
        "DoNotEscapeTokens": "",
        "DisableReferer": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "Content-Type"
          }
        ],
        "UseDNNProxySettings": "",
        "AddCurrentCookies": "",
        "OutputParameters": "",
        "CookieContainerToken": "",
        "OutputTokenName": "",
        "OutputHeaders": "",
        "IgnoreErrors": "",
        "Events": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "If they reply to a text outside of the link",
      "ActionType": "TwilioSendSms",
      "OrderIndex": 10,
      "Condition": "[AVMReturn:Body].ToLower != \"start\" && [AVMReturn:Body].ToLower != \"start \" && [AVMReturn:Body].ToLower != \" start\" && [AVMReturn:Body].ToLower != \" start \" && [AVMReturn:Body].ToLower != \" start  \" && [AVMReturn:Body].ToLower != \"stop\" && [AVMReturn:Body].ToLower != \"stop \" && [AVMReturn:Body].ToLower != \" stop\" && [AVMReturn:Body].ToLower != \" stop \" && [AVMReturn:Body].ToLower != \" stop  \"",
      "Parameters": {
        "Credentials": {
          "Type": "twilio.apikeys",
          "Group": "2",
          "EntireGroup": false,
          "Entry": "d5763e2b-6094-464e-a101-e890763b7a6a"
        },
        "FromNumber": "+16174683541",
        "ToNumber": "+1[AVMText:CellPhone]",
        "SmsBody": "Not Delivered!  Please use the Reply link in the text stream",
        "StatusCallbackUrl": "https://z5portal.com/DesktopModules/DnnSharp/DnnApiEndpoint/Api.ashx?method=AVMMessageStatus",
        "OutputMessageId": "MessageId",
        "IgnoreErrors": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    }
  ],
  "OnErrorActions": []
}