{
  "Name": "AVMTextReply",
  "Description": "Absolute Value Appraisal Mangement Text Reply",
  "HttpMethod": "POST",
  "IsEnabled": true,
  "OrderIndex": 0,
  "CrossDomainPolicy": "Public",
  "Inputs": [
    {
      "Name": "MessageStatus",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 0,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    }
  ],
  "Actions": [
    {
      "ActionType": "TwilioParseWebhook",
      "OrderIndex": 0,
      "Parameters": {
        "OutputToken": "AVMReturn"
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Cell from SMS Message",
      "ActionType": "RunSql",
      "OrderIndex": 1,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select RIGHT('[AVMReturn:From]',10)",
        "BindTokens": "",
        "OutputTokenName": "CellRaw",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Format Cell with - - -",
      "ActionType": "RunSql",
      "OrderIndex": 2,
      "Condition": "false",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Format([CellRaw], '###-###-####')",
        "BindTokens": "",
        "OutputTokenName": "CellFormatted",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Stop - Update AVPAppraiser with Opt Out",
      "ActionType": "RunSql",
      "OrderIndex": 3,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Update app.AVMAppraiser \nSet OptOut = 'yes', OptOutDate = '[Date:EasternDateTime]'\nwhere AppraiserCellPhone = '[CellRaw]'",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Stop - Insert New Row - AVMTextMessage",
      "ActionType": "RunSql",
      "OrderIndex": 4,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "",
        "BindTokens": "",
        "OutputTokenName": "AVMText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Data for Stop",
      "ActionType": "RunSql",
      "OrderIndex": 5,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Top 1 FileId from app.AVMTextMessage\nWhere  CellPhone = '[CellRaw]'\nOrder By TimeStamp DESC",
        "BindTokens": "",
        "OutputTokenName": "AVMText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Post back to ValueTrac with STOP",
      "ActionType": "PostData",
      "OrderIndex": 6,
      "Condition": "[AVMReturn:Body].ToLower == 'stop' || [AVMReturn:Body].ToLower == 'stop ' || [AVMReturn:Body].ToLower == ' stop' || [AVMReturn:Body].ToLower == ' stop ' || [AVMReturn:Body].ToLower == ' stop  '",
      "Parameters": {
        "InputParameters": "",
        "URL": "https://avm-staging.myvalutrac.com/api/sms.aspx?key=IGNYfZXhSD3rZarPu4Jz",
        "UrlTokenContext": {
          "Expression": "",
          "Value": "Url",
          "IsExpression": false,
          "Parameters": {}
        },
        "UseSSL": true,
        "Timeout": "",
        "HttpMethod": {
          "Expression": "",
          "Value": "POST",
          "IsExpression": false,
          "Parameters": {}
        },
        "Data": "{\n      \"VtMessageId\": \"[AVMText:VtMessageId]\",\n      \"TimeStamp\": \"[Date:AVMEastern]\",\n      \"VerticalDemandId\": \"[AVMText:MessageSid]\",\n      \"Status\": \"Stop\",\n      \"Descr\": \"Appraiser has Opted Out\"\n}",
        "DoNotEscapeTokens": "",
        "DisableReferer": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "Content-Type"
          }
        ],
        "UseDNNProxySettings": "",
        "AddCurrentCookies": "",
        "OutputParameters": "",
        "CookieContainerToken": "",
        "OutputTokenName": "",
        "OutputHeaders": "",
        "IgnoreErrors": "",
        "Events": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Start",
      "ActionType": "RunSql",
      "OrderIndex": 7,
      "Condition": "[AVMReturn:Body].ToLower == 'start' || [AVMReturn:Body].ToLower == 'start ' || [AVMReturn:Body].ToLower == ' start' || [AVMReturn:Body].ToLower == ' start ' || || [AVMReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Update app.TextOptIn \nSet OptIn = 'yes', DateOptIn = '[Date:EasternDateTime]', DateStop = NULL\nwhere CellPhone = RIGHT('[AVMReturn:From]',10)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Data for Start",
      "ActionType": "RunSql",
      "OrderIndex": 8,
      "Condition": "[AVMReturn:Body].ToLower == 'start' || [AVMReturn:Body].ToLower == 'start ' || [AVMReturn:Body].ToLower == ' start' || [AVMReturn:Body].ToLower == ' start ' || || [AVMReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select Top 1 FileId from app.AVMTextMessage\nWhere  CellPhone = '[CellRaw]'\nOrder By TimeStamp DESC",
        "BindTokens": "",
        "OutputTokenName": "AVMText",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Post back to ValueTrac with START",
      "ActionType": "PostData",
      "OrderIndex": 9,
      "Condition": "[AVMReturn:Body].ToLower == 'start' || [AVMReturn:Body].ToLower == 'start ' || [AVMReturn:Body].ToLower == ' start' || [AVMReturn:Body].ToLower == ' start ' || || [AVMReturn:Body].ToLower == ' start  '",
      "Parameters": {
        "InputParameters": "",
        "URL": "https://avm-staging.myvalutrac.com/api/sms.aspx?key=IGNYfZXhSD3rZarPu4Jz",
        "UrlTokenContext": {
          "Expression": "",
          "Value": "Url",
          "IsExpression": false,
          "Parameters": {}
        },
        "UseSSL": true,
        "Timeout": "",
        "HttpMethod": {
          "Expression": "",
          "Value": "POST",
          "IsExpression": false,
          "Parameters": {}
        },
        "Data": "{\n      \"VtMessageId\": \"[AVMText:VtMessageId]\",\n      \"TimeStamp\": \"[Date:AVMEastern]\",\n      \"VerticalDemandId\": \"[AVMText:MessageSid]\",\n      \"Status\": \"Start\",\n      \"Descr\": \"Appraiser has Opted In\"\n}",
        "DoNotEscapeTokens": "",
        "DisableReferer": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "Content-Type"
          }
        ],
        "UseDNNProxySettings": "",
        "AddCurrentCookies": "",
        "OutputParameters": "",
        "CookieContainerToken": "",
        "OutputTokenName": "",
        "OutputHeaders": "",
        "IgnoreErrors": "",
        "Events": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Insert 1 Bor or COB",
      "ActionType": "RunSql",
      "OrderIndex": 10,
      "Condition": "false",
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Insert into MepTextMessages (Response, Status, StatusHTML, SentTo, LoanGuid, LoanNumber, SentBy, SentByEmail, TextMessage, TextMessageHTML, DateSent, NewFlag) Values (\n'[Mep2:MessageSid]',\n'received',\n'<p><strong><span style=\"color: #0c84e4;\">Received</span></strong></p>',\n'[LoanData:SentBy]',\n'[LoanData:LoanGuid]',\n'[LoanData:LoanNumber]',\n'[LoanData:SentTo]',\n'[LoanData:SentByEmail]',\nN'[Mep2:Body]',\nN'<div class=\"message-blue\"> <p class=\"message-content\">[Mep2:Body]</p><div class=\"message-timestamp-right\">[LoanData:SentTo]</div></div>',\n'[Date:EasternDateTime]',\n'yes'\n)",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    }
  ],
  "OnErrorActions": []
}