{
  "Name": "AVMMessageStatus",
  "HttpMethod": "POST",
  "IsEnabled": true,
  "OrderIndex": 0,
  "CrossDomainPolicy": "Public",
  "Inputs": [
    {
      "Name": "MessageStatus",
      "IsDeleted": false,
      "IsEnabled": true,
      "OrderIndex": 0,
      "Parameters": {
        "Value": ""
      },
      "InputTypeStr": "text",
      "Validations": []
    }
  ],
  "Actions": [
    {
      "ActionType": "TwilioParseWebhook",
      "OrderIndex": 0,
      "Condition": "",
      "Parameters": {
        "OutputToken": "AVMReturn"
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Update Message with delivery status",
      "ActionType": "RunSql",
      "OrderIndex": 1,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "UPDATE app.AVMTextMessage SET DeliveryStatus = '[MessageStatus]'\nWHERE  MessageId = '[AVMReturn:MessageSid]'",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Delay 3 seconds",
      "ActionType": "RunSql",
      "OrderIndex": 2,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "WAITFOR DELAY '00:00:03'",
        "BindTokens": "",
        "OutputTokenName": "",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Get Text Message Data",
      "ActionType": "RunSql",
      "OrderIndex": 3,
      "Parameters": {
        "ConnectionString": "",
        "QueryTimeout": "",
        "SqlQuery": "Select VtMessageId, DeliveryStatus from app.AVMTextMessage\nWhere  MessageId = '[AVMReturn:MessageSid]'",
        "BindTokens": "",
        "OutputTokenName": "Text",
        "ExtractColumns": "",
        "OnError": [],
        "ShowErrors": false
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Post back to ValueTrac with delivered status -- Delivered",
      "ActionType": "PostData",
      "OrderIndex": 4,
      "Condition": "[MessageStatus] == \"delivered\"",
      "Parameters": {
        "InputParameters": "",
        "URL": "https://avm.myvalutrac.com/api/sms.aspx?key=lqqMxU50xrHHMqkPpDXE",
        "UrlTokenContext": {
          "Expression": "",
          "Value": "Url",
          "IsExpression": false,
          "Parameters": {}
        },
        "UseSSL": true,
        "Timeout": "",
        "HttpMethod": {
          "Expression": "",
          "Value": "POST",
          "IsExpression": false,
          "Parameters": {}
        },
        "Data": "{\n      \"VtMessageId\": \"[Text:VtMessageId]\",\n      \"TimeStamp\": \"[Date:AVMEastern]\",\n      \"VerticalDemandId\": \"[AVMReturn:MessageSid]\",\n      \"Status\": \"[Text:DeliveryStatus]\",\n      \"Descr\": \"Message delivered successfully\"\n}",
        "DoNotEscapeTokens": "",
        "DisableReferer": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "Content-Type"
          }
        ],
        "UseDNNProxySettings": "",
        "AddCurrentCookies": "",
        "OutputParameters": "",
        "CookieContainerToken": "",
        "OutputTokenName": "",
        "OutputHeaders": "",
        "IgnoreErrors": "",
        "Events": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "Description": "Post back to ValueTrac with delivered status -- Un Delivered",
      "ActionType": "PostData",
      "OrderIndex": 5,
      "Condition": "[MessageStatus] == \"undelivered\"",
      "Parameters": {
        "InputParameters": "",
        "URL": "https://avm-staging.myvalutrac.com/api/sms.aspx?key=IGNYfZXhSD3rZarPu4Jz",
        "UrlTokenContext": {
          "Expression": "",
          "Value": "Url",
          "IsExpression": false,
          "Parameters": {}
        },
        "UseSSL": true,
        "Timeout": "",
        "HttpMethod": {
          "Expression": "",
          "Value": "POST",
          "IsExpression": false,
          "Parameters": {}
        },
        "Data": "{\n      \"VtMessageId\": \"[Text:VtMessageId]\",\n      \"TimeStamp\": \"[Date:AVMEastern]\",\n      \"VerticalDemandId\": \"[AVMReturn:MessageSid]\",\n      \"Status\": \"[Text:DeliveryStatus]\",\n      \"Descr\": \"Message delivery Unsuccessful\"\n}",
        "DoNotEscapeTokens": "",
        "DisableReferer": "",
        "Headers": [
          {
            "value": "application/json",
            "name": "Content-Type"
          }
        ],
        "UseDNNProxySettings": "",
        "AddCurrentCookies": "",
        "OutputParameters": "",
        "CookieContainerToken": "",
        "OutputTokenName": "",
        "OutputHeaders": "",
        "IgnoreErrors": "",
        "Events": "",
        "OnError": []
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    },
    {
      "ActionType": "SendMail",
      "OrderIndex": 6,
      "Condition": "0",
      "Parameters": {
        "From": "",
        "To": "craig@verticaldemand.com",
        "DetermineEmail": "",
        "ToAllUsers": "",
        "ReplyTo": "",
        "Cc": "",
        "Bcc": "",
        "Subject": "Message Return",
        "Format": {
          "Expression": "",
          "Value": "Html",
          "IsExpression": false,
          "Parameters": {}
        },
        "DnnEmailTemplate": {
          "Expression": "",
          "Value": "",
          "IsExpression": false,
          "Parameters": {}
        },
        "Body": "<p>Status:&nbsp; &nbsp;[MessageStatus]</p><p><!--StartFragment--><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">Message SID:&nbsp; &nbsp;[AVMReturn:MessageSid],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">AccountSID:&nbsp; &nbsp;[<span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">AVMReturn</span>:AccountSid],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">MessagingServiceSID:&nbsp; &nbsp;[AVMReturn:MessagingServiceSid],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">From:&nbsp; &nbsp; [AVMReturn:From],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">To:&nbsp; &nbsp; [AVMReturn:To],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">Body:&nbsp; &nbsp;[AVMReturn:Body],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">NumMedia:&nbsp; &nbsp;[AVMReturn:NumMedia],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">From City:&nbsp; &nbsp; [AVMReturn:FromCity],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">From Country:&nbsp; &nbsp;[AVMReturn:FromCountry],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">From State:&nbsp; &nbsp;[AVMReturn:FromState],</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">From Zip:&nbsp; &nbsp; [AVMReturn:FromZip],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">To City:&nbsp; &nbsp; [AVMReturn:ToCity],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">To Country:&nbsp; &nbsp;[AVMReturn:ToCountry],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">To State:&nbsp; &nbsp;[AVMReturn:ToState],&nbsp;</span></p><p><span style=\"color: rgb(158, 158, 158); font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 13px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">To Zip:&nbsp; &nbsp;[AVMReturn:ToZip]</span><!--EndFragment--><br><br><br></p>",
        "Headers": "",
        "PortalFiles": "",
        "FileToken1": "",
        "IgnoreErros": ""
      },
      "IsEnabled": true,
      "ExecutionType": "OnExecute",
      "Metadata": {}
    }
  ],
  "OnErrorActions": []
}